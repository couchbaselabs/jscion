<html>
<head>
  <title>jscion</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
  <link href="init.css" rel="stylesheet" media="screen">
</head>
<body>
<div id="container"></div>
<script src="/js/underscore-1.5.2.min.js"></script>
<script src="/js/jquery-1.10.2.min.js"></script>
<script src="/js/Ractive-legacy.js"></script>
<script src="/js/jscion.js"></script>
<script src="/js/jscionRactive.js"></script>
<script src="init.js"></script>
<script>
var g_ctx;
var g_tmpl;
var g_ractive;
var g_jractive;

$(function() {
  $.ajax({ url: "init.ract", success: function(tmpl) {
    $.ajax({ url: "init.json", dataType: "json", success: function(data) {
      g_ctx = jscion(data); g_tmpl = tmpl; redraw();
    }});
  }});
});

$(window).bind('hashchange', redraw);

function redraw() {
  redrawTarget(window.location.hash ? window.location.hash.substring(1) : "");
}

function redrawTarget(target) { // A target looks like "ident,key0=val0,key1=val1".
  var app = (g_ctx.getObj("app-info").result || {});
  var ident = target.split(",")[0] || app.startIdent || "app-info";
  var opts = _.reduce(_.tail(target.split(",")),
                      function(o, p) { o[p.split('=')[0]] = p.split('=')[1]; return o; }, {});

  var o = g_ctx.getObj(ident);
  if (o.err || !o.result) {
    $("#container").html("error: no obj with ident: " + ident + ", err: " + o.err);
    return;
  }

  g_jractive = jsionRactive(g_ctx);
  console.log(g_jractive);
  g_ractive = new Ractive({ el: "#container", partials: g_jractive.partials,
                            data: { ctx: g_ctx, renderers: g_jractive.renderers,
                                    obj: o.result, opts: opts, fetch: fetch },
                            template: "{{>" + (app.startPartial || "main}") + "}}\n" + g_tmpl });

  function fetch(into, ident, using) {
    setTimeout(function() { g_ractive[using || "set"](into, g_ctx.getObj(ident || into).result); }, 10);
  }
}
</script>
<script src="bootstrap/js/bootstrap.min.js"></script>
</body>
</html>
